import{ad as H,r as p,ae as v,b as D,b9 as k,c as L,j as r,C as $,q as i,l as c,ap as C,f as G,ba as U,T as t,ah as g,H as P,v as W,al as z,bb as V,bc as O,bd as J,ag as I}from"./index-U_CCWg91.js";import{G as q}from"./grid-wa4VYUzx.js";import{H as A}from"./index-B8T0vdp5.js";import{V as M}from"./v-stack-CGRLQPZF.js";import{B as X}from"./badge-DPauIkpv.js";import{C as Z,a as rr}from"./card-ISAonIUp.js";function b(u){return u.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}function er({value:u,onChange:l,children:h,...f}){return r.jsx("select",{value:u,onChange:s=>l(s.target.value),onFocus:s=>{s.target.style.borderColor="var(--chakra-colors-border-focused)",s.target.style.boxShadow="0 0 0 1px var(--chakra-colors-border-focused)"},onBlur:s=>{s.target.style.borderColor="var(--chakra-colors-input-border)",s.target.style.boxShadow="none"},style:{width:"100%",padding:"0.5rem 0.75rem",borderRadius:"0.375rem",border:"1px solid",backgroundColor:"var(--chakra-colors-input-bg)",borderColor:"var(--chakra-colors-input-border)",color:"var(--chakra-colors-text-primary)",fontSize:"1rem",outline:"none",cursor:"pointer"},...f,children:h})}function cr(){const u=H(),l=L(),[h,f]=p.useState(""),[s,w]=p.useState(""),[n,m]=p.useState([]),[y,_]=p.useState(""),{data:E}=v({queryKey:["categories"],queryFn:()=>I.readCategories()}),{data:K}=v({queryKey:["payment-methods"],queryFn:()=>k.readPaymentMethods({})}),{data:x}=v({queryKey:["today-summary"],queryFn:()=>k.getTodaySalesSummary(),refetchInterval:3e4}),j=v({queryKey:["search-products",h,s],queryFn:()=>k.searchProductsForSale({q:h||"a",categoryId:s||void 0,limit:50}),enabled:!0}),S=D({mutationFn:e=>k.createSale({requestBody:{product_id:e.productId,quantity:e.quantity,unit_price:e.unitPrice,total_amount:e.totalAmount,payment_method_id:e.paymentMethodId}}),onSuccess:()=>{},onError:e=>{const o=e.body?.detail||"Failed to create sale";throw l.showErrorToast(o),e}}),B=e=>{m(o=>{const d=o.find(a=>a.product.id===e.id);return d?d.quantity+1>(e.current_stock||0)?(l.showErrorToast("Insufficient stock"),o):o.map(a=>a.product.id===e.id?{...a,quantity:a.quantity+1}:a):[...o,{product:e,quantity:1}]})},R=e=>{m(o=>o.filter(d=>d.product.id!==e))},T=(e,o)=>{m(d=>d.map(a=>{if(a.product.id===e){const F=a.quantity+o;return F>(a.product.current_stock||0)?(l.showErrorToast("Insufficient stock"),a):{...a,quantity:F}}return a}).filter(a=>a.quantity>0))},N=p.useMemo(()=>n.reduce((e,o)=>e+Number(o.product.selling_price)*o.quantity,0),[n]),Q=p.useMemo(()=>n.reduce((e,o)=>e+o.quantity,0),[n]),Y=async()=>{if(n.length===0){l.showErrorToast("Cart is empty");return}if(!y){l.showErrorToast("Please select a payment method");return}try{for(const e of n){const o=await I.readProduct({id:e.product.id});if(!o.current_stock||o.current_stock<e.quantity){l.showErrorToast(`Insufficient stock for ${e.product.name}. Available: ${o.current_stock||0}`);return}const d=Number(e.product.selling_price),a=d*e.quantity;await S.mutateAsync({productId:e.product.id,quantity:e.quantity,unitPrice:d,totalAmount:a,paymentMethodId:y})}l.showSuccessToast(`${n.length} sale(s) completed successfully`),u.invalidateQueries({queryKey:["today-summary"]}),u.invalidateQueries({queryKey:["search-products"]}),m([]),_(""),f("")}catch(e){console.error("Sale completion error:",e)}};return r.jsx($,{maxW:"full",p:0,h:"calc(100vh - 60px)",children:r.jsxs(q,{templateColumns:{base:"1fr",lg:"1fr 400px"},h:"full",gap:0,children:[r.jsxs(i,{direction:"column",h:"full",borderRight:"1px solid",borderColor:"var(--chakra-colors-input-border)",bg:"var(--chakra-colors-bg-canvas)",children:[r.jsxs(c,{position:"sticky",top:0,zIndex:10,bg:"var(--chakra-colors-bg-surface)",borderBottom:"1px solid",borderColor:"var(--chakra-colors-input-border)",p:4,children:[r.jsx(A,{size:"lg",mb:4,children:"Product Search"}),r.jsxs(C,{gap:3,children:[r.jsxs(c,{position:"relative",children:[r.jsx(G,{placeholder:"Search products by name...",value:h,onChange:e=>f(e.target.value),bg:"var(--chakra-colors-input-bg)",borderColor:"var(--chakra-colors-input-border)",color:"var(--chakra-colors-text-primary)",size:"lg",_focus:{borderColor:"var(--chakra-colors-border-focused)",boxShadow:"0 0 0 1px var(--chakra-colors-border-focused)"}}),r.jsx(c,{position:"absolute",right:3,top:"50%",transform:"translateY(-50%)",pointerEvents:"none",children:r.jsx(U,{size:20})})]}),r.jsxs(c,{children:[r.jsx(t,{fontSize:"sm",fontWeight:"medium",mb:2,children:"Filter by Category"}),r.jsxs(i,{gap:2,flexWrap:"wrap",children:[r.jsx(g,{size:"sm",variant:s===""?"solid":"outline",colorScheme:s===""?"blue":"gray",onClick:()=>w(""),children:"All"}),E?.data?.map(e=>r.jsx(g,{size:"sm",variant:s===e.id?"solid":"outline",colorScheme:s===e.id?"blue":"gray",onClick:()=>w(e.id),children:e.name},e.id))]})]})]})]}),r.jsx(c,{flex:1,overflowY:"auto",p:4,children:j.isLoading?r.jsx(q,{templateColumns:"repeat(auto-fill, minmax(160px, 1fr))",gap:3,children:[...Array(8)].map((e,o)=>r.jsx(c,{h:"200px",bg:"var(--chakra-colors-bg-surface)",borderRadius:"lg"},o))}):j.data&&j.data.length>0?r.jsx(q,{templateColumns:"repeat(auto-fill, minmax(160px, 1fr))",gap:3,children:j.data.map(e=>r.jsx(Z,{cursor:"pointer",onClick:()=>B(e),borderWidth:1,borderColor:"var(--chakra-colors-input-border)",transition:"all 0.2s",_hover:{borderColor:"var(--chakra-colors-border-focused)",boxShadow:"lg",transform:"translateY(-2px)"},_active:{transform:"scale(0.98)"},children:r.jsx(rr,{p:3,children:r.jsxs(M,{align:"stretch",gap:2,children:[r.jsx(X,{colorScheme:"purple",alignSelf:"flex-start",fontSize:"xs",children:e.category?.name}),r.jsx(t,{fontWeight:"bold",fontSize:"sm",lineClamp:2,minH:"40px",children:e.name}),r.jsx(i,{justify:"space-between",align:"center",mt:2,children:r.jsxs(t,{fontSize:"xl",fontWeight:"bold",color:"green.500",children:["Ksh ",b(Number(e.selling_price))]})}),r.jsxs(t,{fontSize:"xs",color:"gray.500",children:["Stock: ",e.current_stock]}),r.jsx(g,{size:"sm",colorScheme:"blue",w:"full",children:"Add"})]})})},e.id))}):r.jsxs(i,{direction:"column",align:"center",justify:"center",h:"full",gap:4,children:[r.jsx(t,{fontSize:"lg",color:"gray.500",children:"No products found"}),r.jsx(t,{fontSize:"sm",color:"gray.400",children:h||s?"Try a different search or category":"No products available"})]})})]}),r.jsxs(i,{direction:"column",h:"full",bg:"var(--chakra-colors-bg-surface)",children:[r.jsx(c,{borderBottom:"1px solid",borderColor:"var(--chakra-colors-input-border)",p:4,children:r.jsxs(i,{justify:"space-between",align:"center",children:[r.jsx(A,{size:"md",children:r.jsxs(P,{children:[r.jsx(W,{}),r.jsxs(t,{children:["Cart (",Q,")"]})]})}),n.length>0&&r.jsx(g,{size:"sm",variant:"ghost",colorScheme:"red",onClick:()=>m([]),children:"Clear All"})]})}),r.jsx(c,{flex:1,overflowY:"auto",p:4,children:n.length===0?r.jsxs(i,{direction:"column",align:"center",justify:"center",h:"full",gap:4,children:[r.jsx(W,{size:48,color:"var(--chakra-colors-gray-400)"}),r.jsx(t,{fontSize:"lg",color:"gray.500",textAlign:"center",children:"Cart is empty"}),r.jsx(t,{fontSize:"sm",color:"gray.400",textAlign:"center",children:"Search and click products to add"})]}):r.jsx(C,{gap:3,children:n.map(e=>r.jsxs(c,{p:3,borderWidth:1,borderRadius:"md",borderColor:"var(--chakra-colors-input-border)",bg:"var(--chakra-colors-bg-canvas)",children:[r.jsxs(i,{justify:"space-between",align:"start",mb:2,children:[r.jsxs(M,{align:"start",flex:1,gap:1,children:[r.jsx(t,{fontWeight:"bold",fontSize:"sm",lineClamp:2,children:e.product.name}),r.jsxs(t,{fontSize:"xs",color:"gray.500",children:["Ksh ",b(Number(e.product.selling_price))," each"]})]}),r.jsx(z,{size:"xs",variant:"ghost",colorScheme:"red",onClick:()=>R(e.product.id),"aria-label":"Remove from cart",children:r.jsx(V,{})})]}),r.jsxs(i,{justify:"space-between",align:"center",children:[r.jsxs(P,{gap:2,children:[r.jsx(z,{size:"sm",onClick:()=>T(e.product.id,-1),"aria-label":"Decrease quantity",variant:"outline",children:r.jsx(O,{})}),r.jsx(t,{fontWeight:"bold",minW:"40px",textAlign:"center",fontSize:"lg",children:e.quantity}),r.jsx(z,{size:"sm",onClick:()=>T(e.product.id,1),"aria-label":"Increase quantity",variant:"outline",children:r.jsx(J,{})})]}),r.jsxs(t,{fontWeight:"bold",fontSize:"lg",color:"green.500",children:["Ksh ",b(Number(e.product.selling_price)*e.quantity)]})]})]},e.product.id))})}),r.jsx(c,{borderTop:"2px solid",borderColor:"var(--chakra-colors-input-border)",p:4,bg:"var(--chakra-colors-bg-surface)",children:r.jsxs(C,{gap:3,children:[n.length>0&&r.jsxs(c,{children:[r.jsx(t,{fontWeight:"bold",mb:2,fontSize:"sm",children:"Payment Method *"}),r.jsxs(er,{value:y,onChange:_,children:[r.jsx("option",{value:"",children:"Select payment method..."}),K?.data?.map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})]}),r.jsxs(i,{justify:"space-between",align:"center",py:2,children:[r.jsx(t,{fontSize:"lg",fontWeight:"bold",children:"Total"}),r.jsxs(t,{fontSize:"3xl",fontWeight:"bold",color:"green.500",children:["Ksh ",b(N)]})]}),r.jsx(g,{size:"lg",h:"60px",fontSize:"xl",fontWeight:"bold",colorScheme:"green",onClick:Y,disabled:n.length===0||!y||S.isPending,loading:S.isPending,w:"full",children:S.isPending?"Processing...":"SELL"}),x&&x.total_sales>0&&r.jsxs(c,{mt:2,p:3,borderRadius:"md",bg:"var(--chakra-colors-bg-canvas)",borderWidth:1,borderColor:"var(--chakra-colors-input-border)",children:[r.jsx(t,{fontSize:"xs",fontWeight:"bold",mb:2,color:"gray.500",children:"TODAY'S SUMMARY"}),r.jsxs(i,{justify:"space-between",fontSize:"sm",children:[r.jsx(t,{children:"Sales"}),r.jsxs(t,{fontWeight:"bold",children:["Ksh ",b(Number(x.total_amount)||0)]})]}),r.jsxs(i,{justify:"space-between",fontSize:"sm",color:"gray.500",children:[r.jsxs(t,{children:[x.total_sales," transactions"]}),r.jsxs(t,{children:[x.total_items," items"]})]})]})]})})]})]})})}export{cr as component};
