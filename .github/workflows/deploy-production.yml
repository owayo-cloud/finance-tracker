name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allow manual triggering
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - master

jobs:
  deploy:
    # Do not deploy in the main repository, only in user projects
    # Only deploy if CI workflow completed successfully (when triggered by workflow_run)
    if: |
      github.repository_owner != 'fastapi' &&
      (github.event_name == 'workflow_dispatch' || 
       github.event_name == 'push' || 
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to production server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          APP_DIR: ${{ secrets.APP_DIR }}
          GIT_REPOSITORY: ${{ github.repository }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << ENDSSH
            set -e
            APP_DIR_PATH="${APP_DIR:-/root/code/finance-tracker}"
            if [ ! -d "\${APP_DIR_PATH}/.git" ]; then
              echo "Repository not found on server. Cloning fresh copy..."
              rm -rf "\${APP_DIR_PATH}"
              git clone "https://github.com/${GIT_REPOSITORY}.git" "\${APP_DIR_PATH}"
            fi
            cd "\${APP_DIR_PATH}"
            
            # Pull latest code from GitHub
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # Set environment variables
            export DOMAIN=${{ secrets.DOMAIN_PRODUCTION }}
            export STACK_NAME=${{ secrets.STACK_NAME_PRODUCTION }}
            export ENVIRONMENT=production
            export FRONTEND_HOST=${{ secrets.FRONTEND_HOST }}
            export BACKEND_CORS_ORIGINS=${{ secrets.BACKEND_CORS_ORIGINS }}
            export SECRET_KEY=${{ secrets.SECRET_KEY }}
            export FIRST_SUPERUSER=${{ secrets.FIRST_SUPERUSER }}
            export FIRST_SUPERUSER_PASSWORD=${{ secrets.FIRST_SUPERUSER_PASSWORD }}
            export SMTP_HOST=${{ secrets.SMTP_HOST }}
            export SMTP_USER=${{ secrets.SMTP_USER }}
            export SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
            export EMAILS_FROM_EMAIL=${{ secrets.EMAILS_FROM_EMAIL }}
            export POSTGRES_SERVER=db
            export POSTGRES_PORT=${{ secrets.POSTGRES_PORT || '5432' }}
            export POSTGRES_DB=${{ secrets.POSTGRES_DB || 'app' }}
            export POSTGRES_USER=${{ secrets.POSTGRES_USER || 'postgres' }}
            export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            export SENTRY_DSN=${{ secrets.SENTRY_DSN || '' }}
            export DOCKER_IMAGE_BACKEND=${{ secrets.DOCKER_IMAGE_BACKEND || 'finance-tracker-backend' }}
            export DOCKER_IMAGE_FRONTEND=${{ secrets.DOCKER_IMAGE_FRONTEND || 'finance-tracker-frontend' }}
            export TAG=latest
            
            # Build and restart services
            echo "Building Docker images..."
            docker compose -f docker-compose.yml build
            
            echo "Starting services..."
            docker compose -f docker-compose.yml up -d
            
            # Restart supervisor processes in backend container
            echo "Restarting supervisor processes..."
            BACKEND_CONTAINER=$(docker compose ps -q backend)
            if [ ! -z "$BACKEND_CONTAINER" ]; then
              docker exec $BACKEND_CONTAINER supervisorctl restart all || true
            fi
            
            echo "Deployment completed successfully!"
            
            # Show service status
            docker compose ps
          ENDSSH

      - name: Verify deployment
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << ENDSSH
            APP_DIR_PATH="${APP_DIR:-/root/code/finance-tracker}"
            cd "\${APP_DIR_PATH}"
            echo "Checking service health..."
            docker compose ps
            echo "Checking backend health..."
            BACKEND_CONTAINER=$(docker compose ps -q backend)
            if [ ! -z "$BACKEND_CONTAINER" ]; then
              docker exec $BACKEND_CONTAINER supervisorctl status || true
            fi
          ENDSSH
