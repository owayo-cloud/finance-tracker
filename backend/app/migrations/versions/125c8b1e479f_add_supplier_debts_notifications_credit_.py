"""add_supplier_debts_notifications_credit_limits

Revision ID: 125c8b1e479f
Revises: dc3fa9d8106e
Create Date: 2025-11-23 01:39:10.612080

"""
from alembic import op
import sqlalchemy as sa
import sqlmodel.sql.sqltypes


# revision identifiers, used by Alembic.
revision = '125c8b1e479f'
down_revision = 'dc3fa9d8106e'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('notification',
    sa.Column('user_id', sa.Uuid(), nullable=False),
    sa.Column('notification_type', sqlmodel.sql.sqltypes.AutoString(length=50), nullable=False),
    sa.Column('title', sqlmodel.sql.sqltypes.AutoString(length=200), nullable=False),
    sa.Column('message', sqlmodel.sql.sqltypes.AutoString(length=2000), nullable=False),
    sa.Column('priority', sqlmodel.sql.sqltypes.AutoString(length=20), nullable=False),
    sa.Column('is_read', sa.Boolean(), nullable=False),
    sa.Column('read_at', sa.DateTime(), nullable=True),
    sa.Column('link_url', sqlmodel.sql.sqltypes.AutoString(length=500), nullable=True),
    sa.Column('link_text', sqlmodel.sql.sqltypes.AutoString(length=100), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('id', sa.Uuid(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('reminder_setting',
    sa.Column('user_id', sa.Uuid(), nullable=False),
    sa.Column('reminder_type', sqlmodel.sql.sqltypes.AutoString(length=50), nullable=False),
    sa.Column('is_enabled', sa.Boolean(), nullable=False),
    sa.Column('frequency', sqlmodel.sql.sqltypes.AutoString(length=20), nullable=False),
    sa.Column('send_time', sqlmodel.sql.sqltypes.AutoString(length=8), nullable=False),
    sa.Column('send_days', sa.JSON(), nullable=True),
    sa.Column('filter_criteria', sa.JSON(), nullable=True),
    sa.Column('last_sent_at', sa.DateTime(), nullable=True),
    sa.Column('next_send_at', sa.DateTime(), nullable=True),
    sa.Column('id', sa.Uuid(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('reminder_log',
    sa.Column('reminder_setting_id', sa.Uuid(), nullable=True),
    sa.Column('user_id', sa.Uuid(), nullable=False),
    sa.Column('sent_to_email', sqlmodel.sql.sqltypes.AutoString(length=255), nullable=False),
    sa.Column('sent_at', sa.DateTime(), nullable=False),
    sa.Column('status', sqlmodel.sql.sqltypes.AutoString(length=20), nullable=False),
    sa.Column('error_message', sqlmodel.sql.sqltypes.AutoString(length=2000), nullable=True),
    sa.Column('items_included', sa.Integer(), nullable=False),
    sa.Column('subject_line', sqlmodel.sql.sqltypes.AutoString(length=500), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('id', sa.Uuid(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['reminder_setting_id'], ['reminder_setting.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('supplier_debt',
    sa.Column('supplier_id', sa.Uuid(), nullable=False),
    sa.Column('grn_id', sa.Uuid(), nullable=False),
    sa.Column('total_amount', sa.Numeric(scale=2), nullable=False),
    sa.Column('amount_paid', sa.Numeric(scale=2), nullable=False),
    sa.Column('balance', sa.Numeric(scale=2), nullable=False),
    sa.Column('payment_terms', sqlmodel.sql.sqltypes.AutoString(length=50), nullable=False),
    sa.Column('credit_period_days', sa.Integer(), nullable=True),
    sa.Column('invoice_number', sqlmodel.sql.sqltypes.AutoString(length=100), nullable=True),
    sa.Column('invoice_date', sa.DateTime(), nullable=False),
    sa.Column('due_date', sa.DateTime(), nullable=False),
    sa.Column('status', sqlmodel.sql.sqltypes.AutoString(length=20), nullable=False),
    sa.Column('is_overdue', sa.Boolean(), nullable=False),
    sa.Column('days_overdue', sa.Integer(), nullable=False),
    sa.Column('currency', sqlmodel.sql.sqltypes.AutoString(length=10), nullable=False),
    sa.Column('notes', sqlmodel.sql.sqltypes.AutoString(length=2000), nullable=True),
    sa.Column('id', sa.Uuid(), nullable=False),
    sa.Column('created_by_id', sa.Uuid(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['grn_id'], ['grn.id'], ),
    sa.ForeignKeyConstraint(['supplier_id'], ['supplier.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('supplier_product_reorder',
    sa.Column('supplier_id', sa.Uuid(), nullable=False),
    sa.Column('product_id', sa.Uuid(), nullable=False),
    sa.Column('reorder_level', sa.Numeric(scale=2), nullable=False),
    sa.Column('reorder_quantity', sa.Numeric(scale=2), nullable=False),
    sa.Column('priority', sa.Integer(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('id', sa.Uuid(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.ForeignKeyConstraint(['supplier_id'], ['supplier.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('supplier_debt_installment',
    sa.Column('supplier_debt_id', sa.Uuid(), nullable=False),
    sa.Column('installment_number', sa.Integer(), nullable=False),
    sa.Column('installment_amount', sa.Numeric(scale=2), nullable=False),
    sa.Column('due_date', sa.DateTime(), nullable=False),
    sa.Column('amount_paid', sa.Numeric(scale=2), nullable=False),
    sa.Column('balance', sa.Numeric(scale=2), nullable=False),
    sa.Column('status', sqlmodel.sql.sqltypes.AutoString(length=20), nullable=False),
    sa.Column('notes', sqlmodel.sql.sqltypes.AutoString(length=1000), nullable=True),
    sa.Column('id', sa.Uuid(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['supplier_debt_id'], ['supplier_debt.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('supplier_debt_payment',
    sa.Column('supplier_debt_id', sa.Uuid(), nullable=False),
    sa.Column('installment_id', sa.Uuid(), nullable=True),
    sa.Column('payment_amount', sa.Numeric(scale=2), nullable=False),
    sa.Column('payment_date', sa.DateTime(), nullable=False),
    sa.Column('payment_method_id', sa.Uuid(), nullable=False),
    sa.Column('payment_reference', sqlmodel.sql.sqltypes.AutoString(length=200), nullable=True),
    sa.Column('notes', sqlmodel.sql.sqltypes.AutoString(length=1000), nullable=True),
    sa.Column('id', sa.Uuid(), nullable=False),
    sa.Column('created_by_id', sa.Uuid(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['installment_id'], ['supplier_debt_installment.id'], ),
    sa.ForeignKeyConstraint(['payment_method_id'], ['payment_method.id'], ),
    sa.ForeignKeyConstraint(['supplier_debt_id'], ['supplier_debt.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # Add GRN columns with defaults for existing rows
    op.add_column('grn', sa.Column('payment_type', sqlmodel.sql.sqltypes.AutoString(length=20), server_default='Cash', nullable=False))
    op.add_column('grn', sa.Column('credit_terms', sqlmodel.sql.sqltypes.AutoString(length=50), nullable=True))
    op.add_column('grn', sa.Column('requires_approval', sa.Boolean(), server_default='false', nullable=False))
    op.add_column('grn', sa.Column('creates_debt', sa.Boolean(), server_default='false', nullable=False))
    
    # Add Product columns with defaults for existing rows
    op.add_column('product', sa.Column('reorder_quantity', sa.Numeric(scale=2), nullable=True))
    op.add_column('product', sa.Column('enable_reorder_alerts', sa.Boolean(), server_default='false', nullable=False))
    op.add_column('product', sa.Column('last_reorder_alert_sent', sa.DateTime(), nullable=True))
    op.add_column('product', sa.Column('consecutive_reorder_alerts', sa.Integer(), server_default='0', nullable=False))
    op.add_column('product', sa.Column('max_consecutive_alerts', sa.Integer(), server_default='5', nullable=False))
    
    # Add Supplier columns with defaults for existing rows
    op.add_column('supplier', sa.Column('credit_limit', sa.Numeric(scale=2), server_default='0', nullable=False))
    op.add_column('supplier', sa.Column('current_credit_used', sa.Numeric(scale=2), server_default='0', nullable=False))
    
    # Add User columns with defaults for existing rows
    op.add_column('user', sa.Column('notification_preferences', sa.JSON(), server_default='{"email": true, "in_app": true}', nullable=True))
    op.add_column('user', sa.Column('receives_supplier_debt_alerts', sa.Boolean(), server_default='false', nullable=False))
    op.add_column('user', sa.Column('receives_reorder_alerts', sa.Boolean(), server_default='false', nullable=False))
    op.add_column('user', sa.Column('receives_grn_approval_requests', sa.Boolean(), server_default='false', nullable=False))
    
    # Create indexes for performance optimization
    # Supplier Debt indexes
    op.create_index('idx_supplier_debt_supplier_id', 'supplier_debt', ['supplier_id'])
    op.create_index('idx_supplier_debt_grn_id', 'supplier_debt', ['grn_id'])
    op.create_index('idx_supplier_debt_status', 'supplier_debt', ['status'])
    op.create_index('idx_supplier_debt_is_overdue', 'supplier_debt', ['is_overdue'])
    op.create_index('idx_supplier_debt_due_date', 'supplier_debt', ['due_date'])
    
    # Supplier Debt Payment indexes
    op.create_index('idx_supplier_debt_payment_debt_id', 'supplier_debt_payment', ['supplier_debt_id'])
    op.create_index('idx_supplier_debt_payment_installment_id', 'supplier_debt_payment', ['installment_id'])
    op.create_index('idx_supplier_debt_payment_date', 'supplier_debt_payment', ['payment_date'])
    
    # Supplier Debt Installment indexes
    op.create_index('idx_supplier_debt_installment_debt_id', 'supplier_debt_installment', ['supplier_debt_id'])
    op.create_index('idx_supplier_debt_installment_status', 'supplier_debt_installment', ['status'])
    op.create_index('idx_supplier_debt_installment_due_date', 'supplier_debt_installment', ['due_date'])
    
    # Notification indexes
    op.create_index('idx_notification_user_id', 'notification', ['user_id'])
    op.create_index('idx_notification_is_read', 'notification', ['is_read'])
    op.create_index('idx_notification_type', 'notification', ['notification_type'])
    op.create_index('idx_notification_created_at', 'notification', ['created_at'])
    op.create_index('idx_notification_priority', 'notification', ['priority'])
    
    # Reminder Setting indexes
    op.create_index('idx_reminder_setting_user_id', 'reminder_setting', ['user_id'])
    op.create_index('idx_reminder_setting_type', 'reminder_setting', ['reminder_type'])
    op.create_index('idx_reminder_setting_enabled', 'reminder_setting', ['is_enabled'])
    op.create_index('idx_reminder_setting_next_send', 'reminder_setting', ['next_send_at'])
    
    # Reminder Log indexes
    op.create_index('idx_reminder_log_user_id', 'reminder_log', ['user_id'])
    op.create_index('idx_reminder_log_setting_id', 'reminder_log', ['reminder_setting_id'])
    op.create_index('idx_reminder_log_status', 'reminder_log', ['status'])
    op.create_index('idx_reminder_log_sent_at', 'reminder_log', ['sent_at'])
    
    # Supplier Product Reorder indexes
    op.create_index('idx_supplier_product_reorder_supplier_id', 'supplier_product_reorder', ['supplier_id'])
    op.create_index('idx_supplier_product_reorder_product_id', 'supplier_product_reorder', ['product_id'])
    op.create_index('idx_supplier_product_reorder_active', 'supplier_product_reorder', ['is_active'])
    
    # Product reorder alert indexes
    op.create_index('idx_product_enable_reorder_alerts', 'product', ['enable_reorder_alerts'])
    op.create_index('idx_product_last_reorder_alert_sent', 'product', ['last_reorder_alert_sent'])
    
    # GRN payment type index
    op.create_index('idx_grn_payment_type', 'grn', ['payment_type'])
    op.create_index('idx_grn_creates_debt', 'grn', ['creates_debt'])
    op.create_index('idx_grn_requires_approval', 'grn', ['requires_approval'])
    
    # Add CHECK constraints for balance calculations
    op.execute("""
        ALTER TABLE supplier_debt 
        ADD CONSTRAINT chk_supplier_debt_balance 
        CHECK (balance = total_amount - amount_paid)
    """)
    
    op.execute("""
        ALTER TABLE supplier_debt 
        ADD CONSTRAINT chk_supplier_debt_amounts 
        CHECK (amount_paid >= 0 AND amount_paid <= total_amount)
    """)
    
    op.execute("""
        ALTER TABLE supplier_debt_installment 
        ADD CONSTRAINT chk_installment_balance 
        CHECK (balance = installment_amount - amount_paid)
    """)
    
    op.execute("""
        ALTER TABLE supplier_debt_installment 
        ADD CONSTRAINT chk_installment_amounts 
        CHECK (amount_paid >= 0 AND amount_paid <= installment_amount)
    """)
    
    op.execute("""
        ALTER TABLE supplier 
        ADD CONSTRAINT chk_supplier_credit_used 
        CHECK (current_credit_used >= 0 AND current_credit_used <= credit_limit)
    """)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Drop CHECK constraints first
    op.execute("ALTER TABLE supplier DROP CONSTRAINT IF EXISTS chk_supplier_credit_used")
    op.execute("ALTER TABLE supplier_debt_installment DROP CONSTRAINT IF EXISTS chk_installment_amounts")
    op.execute("ALTER TABLE supplier_debt_installment DROP CONSTRAINT IF EXISTS chk_installment_balance")
    op.execute("ALTER TABLE supplier_debt DROP CONSTRAINT IF EXISTS chk_supplier_debt_amounts")
    op.execute("ALTER TABLE supplier_debt DROP CONSTRAINT IF EXISTS chk_supplier_debt_balance")
    
    # Drop indexes
    op.drop_index('idx_grn_requires_approval', table_name='grn')
    op.drop_index('idx_grn_creates_debt', table_name='grn')
    op.drop_index('idx_grn_payment_type', table_name='grn')
    op.drop_index('idx_product_last_reorder_alert_sent', table_name='product')
    op.drop_index('idx_product_enable_reorder_alerts', table_name='product')
    op.drop_index('idx_supplier_product_reorder_active', table_name='supplier_product_reorder')
    op.drop_index('idx_supplier_product_reorder_product_id', table_name='supplier_product_reorder')
    op.drop_index('idx_supplier_product_reorder_supplier_id', table_name='supplier_product_reorder')
    op.drop_index('idx_reminder_log_sent_at', table_name='reminder_log')
    op.drop_index('idx_reminder_log_status', table_name='reminder_log')
    op.drop_index('idx_reminder_log_setting_id', table_name='reminder_log')
    op.drop_index('idx_reminder_log_user_id', table_name='reminder_log')
    op.drop_index('idx_reminder_setting_next_send', table_name='reminder_setting')
    op.drop_index('idx_reminder_setting_enabled', table_name='reminder_setting')
    op.drop_index('idx_reminder_setting_type', table_name='reminder_setting')
    op.drop_index('idx_reminder_setting_user_id', table_name='reminder_setting')
    op.drop_index('idx_notification_priority', table_name='notification')
    op.drop_index('idx_notification_created_at', table_name='notification')
    op.drop_index('idx_notification_type', table_name='notification')
    op.drop_index('idx_notification_is_read', table_name='notification')
    op.drop_index('idx_notification_user_id', table_name='notification')
    op.drop_index('idx_supplier_debt_installment_due_date', table_name='supplier_debt_installment')
    op.drop_index('idx_supplier_debt_installment_status', table_name='supplier_debt_installment')
    op.drop_index('idx_supplier_debt_installment_debt_id', table_name='supplier_debt_installment')
    op.drop_index('idx_supplier_debt_payment_date', table_name='supplier_debt_payment')
    op.drop_index('idx_supplier_debt_payment_installment_id', table_name='supplier_debt_payment')
    op.drop_index('idx_supplier_debt_payment_debt_id', table_name='supplier_debt_payment')
    op.drop_index('idx_supplier_debt_due_date', table_name='supplier_debt')
    op.drop_index('idx_supplier_debt_is_overdue', table_name='supplier_debt')
    op.drop_index('idx_supplier_debt_status', table_name='supplier_debt')
    op.drop_index('idx_supplier_debt_grn_id', table_name='supplier_debt')
    op.drop_index('idx_supplier_debt_supplier_id', table_name='supplier_debt')
    
    # Drop columns and tables
    op.drop_column('user', 'receives_grn_approval_requests')
    op.drop_column('user', 'receives_reorder_alerts')
    op.drop_column('user', 'receives_supplier_debt_alerts')
    op.drop_column('user', 'notification_preferences')
    op.drop_column('supplier', 'current_credit_used')
    op.drop_column('supplier', 'credit_limit')
    op.drop_column('product', 'max_consecutive_alerts')
    op.drop_column('product', 'consecutive_reorder_alerts')
    op.drop_column('product', 'last_reorder_alert_sent')
    op.drop_column('product', 'enable_reorder_alerts')
    op.drop_column('product', 'reorder_quantity')
    op.drop_column('grn', 'creates_debt')
    op.drop_column('grn', 'requires_approval')
    op.drop_column('grn', 'credit_terms')
    op.drop_column('grn', 'payment_type')
    op.drop_table('supplier_debt_payment')
    op.drop_table('supplier_debt_installment')
    op.drop_table('supplier_product_reorder')
    op.drop_table('supplier_debt')
    op.drop_table('reminder_log')
    op.drop_table('reminder_setting')
    op.drop_table('notification')
    # ### end Alembic commands ###
